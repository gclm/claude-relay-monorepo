# CLAUDE.md

æ­¤æ–‡ä»¶ä¸º Claude Code (claude.ai/code) åœ¨æ­¤ä»£ç ä»“åº“ä¸­å·¥ä½œæ—¶æä¾›æŒ‡å¯¼ã€‚

## å¼€å‘å‘½ä»¤

### æ ¸å¿ƒå¼€å‘å‘½ä»¤
- `npm run dev:frontend` - å¯åŠ¨ Nuxt å‰ç«¯å¼€å‘æœåŠ¡å™¨ (localhost:3000)ï¼Œä½¿ç”¨ `nuxt.config.dev.ts` å¼€å‘é…ç½®
- `npm run dev:backend` - ä½¿ç”¨ Bun å¯åŠ¨ Hono åç«¯å¼€å‘æœåŠ¡å™¨ (localhost:8787ï¼Œæ›´å¿«çš„å¯åŠ¨é€Ÿåº¦ï¼Œ--hot çƒ­é‡è½½)
- `npm run dev:backend:wrangler` - ä½¿ç”¨ Wrangler å¯åŠ¨åç«¯ï¼ˆæ¨¡æ‹Ÿ Cloudflare Workers ç¯å¢ƒï¼Œç«¯å£ 8787ï¼‰
- `npm run build:all` - åŒæ—¶æ„å»ºå‰ç«¯å’Œåç«¯
- `npm run deploy:all` - æ„å»ºå¹¶éƒ¨ç½²ä¸¤ä¸ªæœåŠ¡åˆ° Cloudflareï¼ˆå…ˆéƒ¨ç½²åç«¯ï¼Œå†éƒ¨ç½²å‰ç«¯ï¼‰

### å•ç‹¬åŒ…å‘½ä»¤
- `npm run build:frontend` / `npm run build:backend` - æ„å»ºå•ç‹¬çš„åŒ…
- `npm run deploy:frontend` / `npm run deploy:backend` - éƒ¨ç½²å•ç‹¬çš„åŒ…åˆ° Cloudflare
- `npm run type-check` - å¯¹åç«¯è¿›è¡Œ TypeScript éªŒè¯ï¼ˆ`tsc --noEmit`ï¼‰

### ä»£ç è´¨é‡
- `npm run lint` - å¯¹æ‰€æœ‰ TypeScript/Vue æ–‡ä»¶è¿è¡Œ ESLint
- `npm run lint:fix` - è‡ªåŠ¨ä¿®å¤ ESLint é—®é¢˜
- `npm run format` - ä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç 
- `npm run format:check` - æ£€æŸ¥æ ¼å¼åŒ–è€Œä¸è¿›è¡Œä¿®æ”¹

## æ¶æ„æ¦‚è§ˆ

è¿™æ˜¯ä¸€ä¸ªåŒ…å« Cloudflare å…¨æ ˆåº”ç”¨çš„ **monorepo**ï¼Œå…·æœ‰å…±äº«çš„ TypeScript ç±»å‹ã€‚

### é¡¹ç›®ç»“æ„
```
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ frontend/          # Nuxt 4 + Vue 3 + Tailwind CSS å‰ç«¯
â”‚   â””â”€â”€ backend/           # Hono + Cloudflare Workers åç«¯
â”œâ”€â”€ shared/                # å…±äº«çš„ TypeScript ç±»å‹å’Œå¸¸é‡
â”‚   â”œâ”€â”€ types/            # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ constants/        # å¸¸é‡é…ç½®
â””â”€â”€ docs/                 # æ–‡æ¡£
```

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Nuxt 4, Vue 3, Tailwind CSS, Piniaï¼Œéƒ¨ç½²åˆ° Cloudflare Pages
- **åç«¯**: Hono æ¡†æ¶, TypeScript, Bun è¿è¡Œæ—¶ï¼Œéƒ¨ç½²åˆ° Cloudflare Workers
- **å…±äº«**: å‰åç«¯å…±äº«çš„ TypeScript ç±»å‹å’Œ API å¸¸é‡
- **å­˜å‚¨**: Cloudflare KV å­˜å‚¨
- **å·¥å…·**: ESLint, Prettier, TypeScript

### å…³é”®æ¶æ„ç‰¹æ€§

#### åç«¯ (Hono + Cloudflare Workers)
- **åŒæ¨¡å¼å¯åŠ¨**: Bun æ¨¡å¼ï¼ˆå¿«é€Ÿå¼€å‘ï¼‰+ Wrangler æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿï¼‰
- **æœåŠ¡åˆ†å±‚æ¶æ„**: è·¯ç”±å±‚(Routes) â†’ æœåŠ¡å±‚(Services) â†’ å­˜å‚¨å±‚(KV)
- **æ™ºèƒ½è·¯ç”±ä»£ç†**: è‡ªåŠ¨è·¯ç”±è¯·æ±‚åˆ°å®˜æ–¹ Claude API æˆ–ç¬¬ä¸‰æ–¹ LLM ä¾›åº”å•†
- **å¤šæ ¼å¼è½¬æ¢å™¨**: æ”¯æŒ Claude-OpenAIã€Claude-Gemini æ ¼å¼åŒå‘è½¬æ¢
- **Key Pool ç®¡ç†**: ä¼ä¸šçº§ API å¯†é’¥æ± ç®¡ç†ï¼Œæ”¯æŒè‡ªåŠ¨è½®æ¢ã€æ•…éšœæ¢å¤å’Œè´Ÿè½½å‡è¡¡
- **ä¾›åº”å•†ç®¡ç†**: åŠ¨æ€é…ç½®å’Œç®¡ç†å¤šä¸ª LLM ä¾›åº”å•†ï¼ˆé­”æ­ã€æ™ºè°± AIã€OpenAI å…¼å®¹ã€Google Geminiï¼‰
- **æ¨¡å—åŒ–æ¶æ„**: æŒ‰åŠŸèƒ½åŸŸåˆ†å±‚ç»„ç»‡ï¼ˆadminã€proxyã€key-poolã€transformersï¼‰
- **ç»Ÿä¸€é”™è¯¯å¤„ç†**: å…¨å±€å¼‚å¸¸æ•è·å’Œæ ‡å‡†åŒ–é”™è¯¯å“åº”
- **å¼€æ”¾ CORS é…ç½®**: æ”¯æŒæ‰€æœ‰æ¥æºè®¿é—®ï¼Œé€‚é… Claude Code å®¢æˆ·ç«¯
- **å®šæ—¶ä»»åŠ¡**: æ¯ 6 å°æ—¶è‡ªåŠ¨åˆ·æ–° Claude è´¦å· Token
- **æœ¬åœ°å­˜å‚¨æ”¯æŒ**: å¼€å‘æ¨¡å¼ä½¿ç”¨æœ¬åœ° KV å­˜å‚¨ï¼Œç”Ÿäº§æ¨¡å¼ä½¿ç”¨ Cloudflare KV

#### å‰ç«¯ (Nuxt 4 + Cloudflare Pages)
- **åŒé…ç½®æ–‡ä»¶**: `nuxt.config.ts`ï¼ˆç”Ÿäº§ï¼‰+ `nuxt.config.dev.ts`ï¼ˆå¼€å‘ï¼‰
- **é’ˆå¯¹ Cloudflare Pages ä¼˜åŒ–**: preset é…ç½®å’Œæ„å»ºä¼˜åŒ–
- **æ™ºèƒ½ä»£ç åˆ†å‰²**: æ‰‹åŠ¨ vendor chunks åˆ†å‰²ï¼ˆvue-vendor, piniaï¼‰
- **ç¼“å­˜ç­–ç•¥**: è·¯ç”±çº§ç¼“å­˜æ§åˆ¶ï¼Œé™æ€èµ„æºé•¿æœŸç¼“å­˜
- **å¼€å‘ä¼˜åŒ–**: ç¦ç”¨ç±»å‹æ£€æŸ¥ã€å‹ç¼©ç­‰æå‡å¼€å‘å¯åŠ¨é€Ÿåº¦
- **ç¯å¢ƒå˜é‡ç®¡ç†**: å¼€å‘ç¯å¢ƒè‡ªåŠ¨è¿æ¥æœ¬åœ°åç«¯ï¼Œç”Ÿäº§ç¯å¢ƒè¿æ¥éƒ¨ç½²çš„åç«¯
- **æ™ºèƒ½æ ‡ç­¾é¡µå¯¼èˆª**: ä»ä¾›åº”å•†ç›¸å…³é¡µé¢è¿”å›æ—¶è‡ªåŠ¨æ˜¾ç¤ºä¾›åº”å•†æ ‡ç­¾é¡µ

#### å…±äº«ä»£ç ç­–ç•¥
- **ç±»å‹å®šä¹‰**: ç®¡ç†ç›¸å…³(`admin.ts`)ã€é€šç”¨ API(`api.ts`)ã€è®¤è¯(`auth.ts`)
- **å¸¸é‡é…ç½®**: ç®¡ç†ä¸­å¿ƒ(`admin.ts`)ã€API ç«¯ç‚¹(`endpoints.ts`)ã€é”™è¯¯ç (`errors.ts`)ã€OAuth(`oauth.ts`)
- **å¯¼å…¥è·¯å¾„**: ä» packages ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¦‚ `../../../shared/types/admin`

### ç¯å¢ƒé…ç½®

#### åç«¯ç¯å¢ƒå˜é‡ (wrangler.toml)
- `NODE_ENV` - ç¯å¢ƒæ ‡è¯† (production/preview/development)
- `ADMIN_USERNAME` / `ADMIN_PASSWORD` - ç®¡ç†ä¸­å¿ƒç™»å½•å‡­æ®ï¼ˆé€šè¿‡ Cloudflare Dashboard è®¾ç½®ï¼‰
- **KV ç»‘å®š**: `CLAUDE_RELAY_ADMIN_KV` - å­˜å‚¨æ‰€æœ‰ç®¡ç†æ•°æ®å’Œé…ç½®
- **å®šæ—¶ä»»åŠ¡**: æ¯ 6 å°æ—¶æ‰§è¡Œ Token åˆ·æ–°ï¼ˆ`0 */6 * * *`ï¼‰

#### å‰ç«¯ç¯å¢ƒå˜é‡
- **ç”Ÿäº§**: `NUXT_PUBLIC_API_BASE_URL=https://claude-relay-backend.117yelixin.workers.dev`
- **å¼€å‘**: `NUXT_PUBLIC_API_BASE_URL=http://localhost:8787`
- `NUXT_PUBLIC_APP_NAME` / `NUXT_PUBLIC_APP_VERSION` - åº”ç”¨å…ƒæ•°æ®

### éƒ¨ç½²æµç¨‹
1. **åç«¯å…ˆéƒ¨ç½²** (`npm run deploy:backend`) - ç¡®ä¿ API å¯ç”¨
2. **å‰ç«¯åéƒ¨ç½²** (`npm run deploy:frontend`) - è¿æ¥åˆ°çº¿ä¸Š API
3. **å®Œæ•´éƒ¨ç½²** (`npm run deploy:all`) - è‡ªåŠ¨åŒ–æ•´ä¸ªåºåˆ—

### å¼€å‘å·¥ä½œæµç¨‹
- **å‰ç«¯**: å¼€å‘æ¨¡å¼è¿æ¥æœ¬åœ°åç«¯ (`localhost:8787`)ï¼Œç”Ÿäº§æ¨¡å¼è¿æ¥éƒ¨ç½²çš„åç«¯
- **åç«¯**: æ¨èä½¿ç”¨ Bun æ¨¡å¼å¼€å‘ï¼Œéƒ¨ç½²å‰ç”¨ Wrangler æ¨¡å¼æµ‹è¯•
- **ç±»å‹å®‰å…¨**: å…±äº«ç±»å‹ç¡®ä¿å‰åç«¯ API å¥‘çº¦ä¸€è‡´æ€§
- **çƒ­é‡è½½**: å‰ç«¯å’Œåç«¯éƒ½æ”¯æŒçƒ­é‡è½½å¼€å‘

#### åç«¯å¼€å‘æ¨¡å¼è¯¦è§£
1. **Bun æ¨¡å¼ï¼ˆæ¨èï¼‰** - `npm run dev:backend`
   - å…¥å£æ–‡ä»¶: `src/index.bun.ts`
   - ä½¿ç”¨ Bun è¿è¡Œæ—¶ï¼Œå¯åŠ¨é€Ÿåº¦æå¿«
   - æœ¬åœ° KV å­˜å‚¨å®ç°ï¼ˆ`utils/local-kv-storage.ts`ï¼‰
   - æ”¯æŒçƒ­é‡è½½ï¼ˆ`--hot` æ ‡å¿—ï¼‰
   - é€‚åˆå¿«é€Ÿå¼€å‘å’Œè°ƒè¯•
   
2. **Wrangler æ¨¡å¼** - `npm run dev:backend:wrangler`
   - å…¥å£æ–‡ä»¶: `src/index.ts`
   - å®Œæ•´çš„ Cloudflare Workers ç¯å¢ƒæ¨¡æ‹Ÿ
   - çœŸå®çš„ KV å­˜å‚¨ï¼ˆè¿œç¨‹æˆ–æœ¬åœ°é¢„è§ˆï¼‰
   - æ›´æ¥è¿‘ç”Ÿäº§ç¯å¢ƒè¡Œä¸º
   - é€‚åˆéƒ¨ç½²å‰æœ€ç»ˆæµ‹è¯•

## åç«¯ API æ¶æ„

### æ ¸å¿ƒ API ç«¯ç‚¹

#### Claude API ä»£ç† (`/v1/*`)
- `POST /v1/messages` - æ™ºèƒ½ä»£ç† Claude APIï¼Œæ”¯æŒå®˜æ–¹ Claude å’Œç¬¬ä¸‰æ–¹ä¾›åº”å•†è·¯ç”±ï¼Œé›†æˆ Key Pool ç®¡ç†
- `GET /v1/health` - Claude API ä»£ç†æœåŠ¡å¥åº·æ£€æŸ¥

#### ç®¡ç†ä¸­å¿ƒ API (`/api/admin/*`)
- `POST /api/admin/auth` - ç®¡ç†å‘˜è®¤è¯ç™»å½•
- `GET /api/admin/dashboard` - è·å–ä»ªè¡¨æ¿æ•°æ®ï¼ˆä¾›åº”å•†ç»Ÿè®¡ã€ç³»ç»ŸçŠ¶æ€ã€è´¦å·ä¿¡æ¯ç­‰ï¼‰
- `GET /api/admin/providers` - è·å–æ‰€æœ‰æ¨¡å‹ä¾›åº”å•†é…ç½®
- `POST /api/admin/providers` - æ·»åŠ æ–°çš„æ¨¡å‹ä¾›åº”å•†
- `PUT /api/admin/providers/:id` - ç¼–è¾‘æ¨¡å‹ä¾›åº”å•†é…ç½®
- `DELETE /api/admin/providers/:id` - åˆ é™¤æ¨¡å‹ä¾›åº”å•†
- `GET /api/admin/models` - è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼ˆå®˜æ–¹ + ç¬¬ä¸‰æ–¹ï¼‰
- `POST /api/admin/select-model` - é€‰æ‹©é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹
- `GET /api/admin/claude-accounts` - è·å– Claude è´¦å·åˆ—è¡¨
- `POST /api/admin/claude-accounts` - æ·»åŠ æ–°çš„ Claude è´¦å·
- `DELETE /api/admin/claude-accounts/:id` - åˆ é™¤ Claude è´¦å·
- `POST /api/admin/claude-accounts/:id/auth` - Claude è´¦å· OAuth è®¤è¯

#### Key Pool ç®¡ç† API (`/api/admin/key-pool/*`)
- `GET /api/admin/key-pool/:providerId` - è·å–æŒ‡å®šä¾›åº”å•†çš„å¯†é’¥æ± çŠ¶æ€
- `POST /api/admin/key-pool/:providerId/keys` - å‘å¯†é’¥æ± æ·»åŠ æ–°å¯†é’¥
- `PUT /api/admin/key-pool/:providerId/keys/:keyId` - æ›´æ–°å¯†é’¥çŠ¶æ€
- `DELETE /api/admin/key-pool/:providerId/keys/:keyId` - åˆ é™¤æŒ‡å®šå¯†é’¥
- `POST /api/admin/key-pool/:providerId/keys/batch` - æ‰¹é‡æ·»åŠ å¯†é’¥
- `POST /api/admin/key-pool/:providerId/keys/batch-operation` - æ‰¹é‡æ“ä½œå¯†é’¥ï¼ˆå¯ç”¨/ç¦ç”¨/åˆ é™¤ï¼‰
- `GET /api/admin/key-pool/:providerId/stats` - è·å–å¯†é’¥æ± è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
- `POST /api/admin/key-pool/:providerId/maintenance` - æ‰§è¡Œå¯†é’¥æ± ç»´æŠ¤ä»»åŠ¡

#### ç³»ç»Ÿç«¯ç‚¹
- `GET /health` - åº”ç”¨å¥åº·æ£€æŸ¥å’Œç³»ç»ŸçŠ¶æ€ä¿¡æ¯

### æœåŠ¡å±‚æ¶æ„

#### ClaudeProxyService (æ™ºèƒ½ä»£ç†æœåŠ¡)
- **æ–‡ä»¶**: `src/services/proxy/claude-proxy.ts`
- **èŒè´£**: æ™ºèƒ½è·¯ç”±è¯·æ±‚åˆ°å®˜æ–¹ Claude API æˆ–ç¬¬ä¸‰æ–¹ä¾›åº”å•†
- **æ ¸å¿ƒæ–¹æ³•**:
  - `proxyRequest(request)` - æ ¹æ®é€‰ä¸­æ¨¡å‹æ™ºèƒ½è·¯ç”±è¯·æ±‚
  - `forwardToClaude(request)` - ä»£ç†åˆ°å®˜æ–¹ Claude API
  - `forwardToProvider(request, provider)` - ä»£ç†åˆ°ç¬¬ä¸‰æ–¹ä¾›åº”å•†
- **ç‰¹æ€§**: è‡ªåŠ¨æ¨¡å‹é€‰æ‹©ã€æ™ºèƒ½è·¯ç”±ã€ç»Ÿä¸€é”™è¯¯å¤„ç†ã€æµå¼å“åº”æ”¯æŒã€é›†æˆ Key Pool ç®¡ç†

#### LLMProxyService (LLM ä»£ç†æœåŠ¡)
- **æ–‡ä»¶**: `src/services/proxy/llm-proxy.ts`
- **èŒè´£**: å¤„ç†ç¬¬ä¸‰æ–¹ LLM ä¾›åº”å•†çš„è¯·æ±‚è½¬å‘å’Œæ ¼å¼è½¬æ¢
- **æ ¸å¿ƒæ–¹æ³•**:
  - `handleRequest(claudeRequest, providerType)` - å¤„ç†å¹¶è½¬å‘è¯·æ±‚åˆ°æŒ‡å®šä¾›åº”å•†
  - `registerProviderFromConfig(provider)` - ä»é…ç½®åŠ¨æ€æ³¨å†Œä¾›åº”å•†
  - `getTransformerForProvider(provider)` - ä¸ºä¾›åº”å•†é€‰æ‹©åˆé€‚çš„è½¬æ¢å™¨
- **ç‰¹æ€§**: åŠ¨æ€ä¾›åº”å•†æ³¨å†Œã€è‡ªåŠ¨æ ¼å¼è½¬æ¢ã€æ”¯æŒå¤šç§è½¬æ¢å™¨ã€é›†æˆ Key Pool ç®¡ç†

#### æ ¼å¼è½¬æ¢å™¨ç³»ç»Ÿ
1. **BaseTransformer** (`src/services/transformers/base-transformer.ts`)
   - æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰è½¬æ¢å™¨æ¥å£æ ‡å‡†
   - æä¾›é€šç”¨çš„è½¬æ¢å™¨æ–¹æ³•å’Œé”™è¯¯å¤„ç†
   
2. **ClaudeToOpenAITransformer** (`src/services/transformers/claude-to-openai.ts`)
   - Claude API â†” OpenAI API æ ¼å¼åŒå‘è½¬æ¢
   - æ”¯æŒæ¶ˆæ¯æ ¼å¼ã€å·¥å…·è°ƒç”¨ã€æµå¼å“åº”è½¬æ¢
   
3. **ClaudeToGeminiTransformer** (`src/services/transformers/claude-to-gemini.ts`)
   - Claude API â†” Google Gemini API æ ¼å¼åŒå‘è½¬æ¢
   - æ”¯æŒ Gemini ç‰¹æœ‰çš„æ¶ˆæ¯æ ¼å¼å’Œå‚æ•°

#### AdminService (ç®¡ç†æœåŠ¡) - æ¨¡å—åŒ–é‡æ„
- **èŒè´£**: ç®¡ç†ä¸­å¿ƒåŠŸèƒ½å®ç°ï¼Œé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„æŒ‰åŠŸèƒ½åŸŸæ‹†åˆ†
- **æ ¸å¿ƒæ¨¡å—**:
  - `AuthService` (`src/services/admin/auth.ts`) - ç®¡ç†å‘˜è®¤è¯
  - `DashboardService` (`src/services/admin/dashboard.ts`) - ä»ªè¡¨æ¿æ•°æ®ç»Ÿè®¡
  - `ProvidersService` (`src/services/admin/providers.ts`) - ä¾›åº”å•†ç®¡ç†
  - `ModelsService` (`src/services/admin/models.ts`) - æ¨¡å‹é€‰æ‹©å’Œåˆ‡æ¢
  - `ClaudeAccountService` (`src/services/admin/claude-accounts.ts`) - Claude è´¦å·ç®¡ç†
  - `KeyPoolService` (`src/services/admin/key-pool.ts`) - Key Pool å¯†é’¥æ± ç®¡ç†
- **ç‰¹æ€§**: æ¨¡å—åŒ–è®¾è®¡ã€èŒè´£å•ä¸€ã€æ˜“äºç»´æŠ¤å’Œæµ‹è¯•

#### KeyPoolService (å¯†é’¥æ± ç®¡ç†æœåŠ¡)
- **æ–‡ä»¶**: `src/services/admin/key-pool.ts`
- **èŒè´£**: ç®¡ç†å¤šä¸ªä¾›åº”å•†çš„ API å¯†é’¥æ± ï¼Œæä¾›å¯†é’¥çš„å¢åˆ æ”¹æŸ¥å’Œç»Ÿè®¡åŠŸèƒ½
- **æ ¸å¿ƒæ–¹æ³•**:
  - `getKeyPoolStatus(providerId)` - è·å–æŒ‡å®šä¾›åº”å•†çš„å¯†é’¥æ± çŠ¶æ€å’Œå¯†é’¥åˆ—è¡¨
  - `addKey(providerId, keyData)` - å‘å¯†é’¥æ± æ·»åŠ æ–°çš„ API å¯†é’¥
  - `updateKeyStatus(providerId, keyId, status)` - æ›´æ–°æŒ‡å®šå¯†é’¥çš„çŠ¶æ€
  - `deleteKey(providerId, keyId)` - åˆ é™¤æŒ‡å®šçš„ API å¯†é’¥
  - `batchAddKeys(providerId, keys)` - æ‰¹é‡æ·»åŠ å¤šä¸ª API å¯†é’¥
  - `batchOperateKeys(providerId, operation, keyIds)` - æ‰¹é‡æ“ä½œå¯†é’¥ï¼ˆå¯ç”¨/ç¦ç”¨/åˆ é™¤ï¼‰
  - `getKeyPoolStats(providerId)` - è·å–å¯†é’¥æ± çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
  - `performMaintenance(providerId)` - æ‰§è¡Œå¯†é’¥æ± ç»´æŠ¤ä»»åŠ¡
- **ç‰¹æ€§**: ä¼ä¸šçº§å¯†é’¥ç®¡ç†ã€æ‰¹é‡æ“ä½œæ”¯æŒã€å®æ—¶ç»Ÿè®¡ç›‘æ§ã€é›†æˆ Key Pool Manager

### æ•°æ®å­˜å‚¨è®¾è®¡

#### KV å­˜å‚¨ç»“æ„
```typescript
// Claude è´¦å·ç®¡ç†
'claude_accounts': ClaudeAccount[]           // Claude è´¦å·åˆ—è¡¨
'claude_account_{{id}}_token': OAuthToken   // å„è´¦å·çš„ OAuth Token

// æ¨¡å‹ä¾›åº”å•†ç®¡ç†
'admin_model_providers': ModelProvider[]    // æ¨¡å‹ä¾›åº”å•†åˆ—è¡¨
'admin_selected_model': SelectedModel       // å½“å‰é€‰ä¸­çš„æ¨¡å‹

// ä¾›åº”å•†é…ç½®ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰
'admin_provider_{{id}}': {
  endpoint: string,
  model: string,
  transformer: string
  // æ³¨æ„ï¼šAPI å¯†é’¥ç»Ÿä¸€é€šè¿‡ Key Pool ç®¡ç†ï¼Œä¸å­˜å‚¨åœ¨ä¾›åº”å•†é…ç½®ä¸­
}

// Key Pool ç®¡ç†
'key_pool_{{providerId}}': KeyPoolData      // æ¯ä¸ªä¾›åº”å•†çš„å¯†é’¥æ± æ•°æ®
'key_pool_stats_{{providerId}}': KeyPoolStats // å¯†é’¥æ± ç»Ÿè®¡ä¿¡æ¯
```

### é”™è¯¯å¤„ç†æœºåˆ¶

#### è‡ªå®šä¹‰é”™è¯¯ç±»å‹ (`src/utils/errors.ts`)
- `AuthError` - OAuth è®¤è¯ç›¸å…³é”™è¯¯
- `TokenExpiredError` - Token è¿‡æœŸé”™è¯¯  
- `ClaudeApiError` - Claude API è°ƒç”¨é”™è¯¯
- `ValidationError` - è¯·æ±‚å‚æ•°éªŒè¯é”™è¯¯
- `ProviderError` - ç¬¬ä¸‰æ–¹ä¾›åº”å•†é”™è¯¯

#### ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
```typescript
{
  success: false,
  error: {
    type: 'ERROR_TYPE',
    message: 'Human readable message'
  },
  timestamp: string
}
```

### æ™ºèƒ½è·¯ç”±æœºåˆ¶

#### è¯·æ±‚è·¯ç”±æµç¨‹
1. æ¥æ”¶ Claude API æ ¼å¼çš„è¯·æ±‚åˆ° `/v1/messages`
2. æ£€æŸ¥å½“å‰é€‰ä¸­çš„æ¨¡å‹é…ç½®
3. **å®˜æ–¹ Claude æ¨¡å‹**: ç›´æ¥è½¬å‘åˆ° Claude API
4. **ç¬¬ä¸‰æ–¹æ¨¡å‹**:
   - æ ¹æ®ä¾›åº”å•†ç±»å‹é€‰æ‹©è½¬æ¢å™¨
   - è½¬æ¢è¯·æ±‚æ ¼å¼ï¼ˆClaude â†’ OpenAI/Geminiï¼‰
   - è½¬å‘åˆ°ç¬¬ä¸‰æ–¹ä¾›åº”å•† API
   - è½¬æ¢å“åº”æ ¼å¼ï¼ˆOpenAI/Gemini â†’ Claudeï¼‰
5. è¿”å›ç»Ÿä¸€çš„ Claude API æ ¼å¼å“åº”

#### Key Pool ç®¡ç†ç³»ç»Ÿ

##### Key Pool æ ¸å¿ƒç»„ä»¶
1. **BaseKeyPool** (`src/services/key-pool/base-key-pool.ts`)
   - æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰ Key Pool æ ‡å‡†æ¥å£
   - æä¾›åŸºç¡€çš„å¯†é’¥ç®¡ç†ã€è½®æ¢ç­–ç•¥å’Œç»Ÿè®¡åŠŸèƒ½
   
2. **GenericKeyPool** (`src/services/key-pool/generic-key-pool.ts`)
   - é€šç”¨ Key Pool å®ç°ï¼Œé€‚ç”¨äº OpenAI å…¼å®¹ API
   - æ”¯æŒé€Ÿç‡é™åˆ¶æ£€æµ‹å’Œè‡ªåŠ¨æ¢å¤
   
3. **GeminiKeyPool** (`src/services/key-pool/gemini-key-pool.ts`)
   - ä¸“é—¨ä¸º Google Gemini API è®¾è®¡çš„ Key Pool
   - é’ˆå¯¹ Gemini API çš„ç‰¹å®šé”™è¯¯ç å’Œé™åˆ¶ä¼˜åŒ–
   
4. **KeyPoolManager** (`src/services/key-pool/key-pool-manager.ts`)
   - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¾›åº”å•†çš„ Key Pool
   - åŠ¨æ€åˆ›å»ºã€ç¼“å­˜å’Œç»´æŠ¤å¤šä¸ª Key Pool å®ä¾‹

##### Key Pool ç‰¹æ€§
- **æ™ºèƒ½è½®æ¢**: æ”¯æŒ round-robinã€randomã€least-used ç­‰ç­–ç•¥
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨æ£€æµ‹é€Ÿç‡é™åˆ¶å’Œé”™è¯¯ï¼Œå®šæ—¶æ¢å¤å¯ç”¨æ€§
- **è´Ÿè½½å‡è¡¡**: æ ¹æ®ä½¿ç”¨é¢‘ç‡å’ŒæˆåŠŸç‡æ™ºèƒ½åˆ†é…è¯·æ±‚
- **ç»Ÿè®¡ç›‘æ§**: å®æ—¶è¿½è¸ªæˆåŠŸç‡ã€å¤±è´¥ç‡å’Œä½¿ç”¨æƒ…å†µ
- **æ‰¹é‡ç®¡ç†**: æ”¯æŒæ‰¹é‡å¯¼å…¥ã€å¯ç”¨ã€ç¦ç”¨å’Œåˆ é™¤å¯†é’¥

#### æ”¯æŒçš„è½¬æ¢å™¨
- `claude-to-openai` - å…¼å®¹ OpenAI API çš„ä¾›åº”å•†ï¼ˆé­”æ­ã€æ™ºè°± AI ç­‰ï¼‰
- `claude-to-gemini` - Google Gemini API ä¾›åº”å•†
- å¯æ‰©å±•ï¼šé€šè¿‡ç»§æ‰¿ `BaseTransformer` æ·»åŠ è‡ªå®šä¹‰è½¬æ¢å™¨

### å…³é”®æ–‡ä»¶ç»“æ„

#### åç«¯æ ¸å¿ƒæ–‡ä»¶
```
packages/backend/src/
â”œâ”€â”€ index.ts                                   # Workers å…¥å£æ–‡ä»¶
â”œâ”€â”€ index.bun.ts                              # Bun å¼€å‘æ¨¡å¼å…¥å£
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ index.ts                              # è·¯ç”±æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ admin/                                # ç®¡ç†ä¸­å¿ƒè·¯ç”±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts                          # ç®¡ç†è·¯ç”±å…¥å£
â”‚   â”‚   â”œâ”€â”€ auth.ts                           # è®¤è¯è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ dashboard.ts                      # ä»ªè¡¨æ¿è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ providers.ts                     # ä¾›åº”å•†ç®¡ç†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ models.ts                         # æ¨¡å‹ç®¡ç†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ claude-accounts.ts                # Claude è´¦å·ç®¡ç†è·¯ç”±
â”‚   â”‚   â””â”€â”€ key-pool.ts                       # Key Pool ç®¡ç†è·¯ç”±
â”‚   â””â”€â”€ proxy/                                # ä»£ç†è·¯ç”±æ¨¡å—
â”‚       â”œâ”€â”€ index.ts                          # ä»£ç†è·¯ç”±å…¥å£
â”‚       â””â”€â”€ claude.ts                         # Claude API ä»£ç†è·¯ç”±
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ index.ts                              # æœåŠ¡æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ admin/                                # ç®¡ç†æœåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts                          # ç®¡ç†æœåŠ¡å…¥å£
â”‚   â”‚   â”œâ”€â”€ auth.ts                           # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ dashboard.ts                      # ä»ªè¡¨æ¿æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ providers.ts                     # ä¾›åº”å•†ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ models.ts                         # æ¨¡å‹ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ claude-accounts.ts                # Claude è´¦å·ç®¡ç†æœåŠ¡
â”‚   â”‚   â””â”€â”€ key-pool.ts                       # Key Pool ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ proxy/                                # ä»£ç†æœåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts                          # ä»£ç†æœåŠ¡å…¥å£
â”‚   â”‚   â”œâ”€â”€ claude-proxy.ts                   # Claude æ™ºèƒ½ä»£ç†æœåŠ¡
â”‚   â”‚   â””â”€â”€ llm-proxy.ts                      # LLM ä»£ç†æœåŠ¡
â”‚   â”œâ”€â”€ key-pool/                             # Key Pool ç®¡ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts                          # Key Pool å…¥å£
â”‚   â”‚   â”œâ”€â”€ base-key-pool.ts                  # Key Pool æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ generic-key-pool.ts               # é€šç”¨ Key Pool å®ç°
â”‚   â”‚   â”œâ”€â”€ gemini-key-pool.ts                # Gemini Key Pool å®ç°
â”‚   â”‚   â””â”€â”€ key-pool-manager.ts               # Key Pool ç®¡ç†å™¨
â”‚   â””â”€â”€ transformers/                         # è½¬æ¢å™¨æ¨¡å—
â”‚       â”œâ”€â”€ index.ts                          # è½¬æ¢å™¨å…¥å£
â”‚       â”œâ”€â”€ base-transformer.ts               # è½¬æ¢å™¨æŠ½è±¡åŸºç±»
â”‚       â”œâ”€â”€ claude-to-openai.ts               # OpenAI æ ¼å¼è½¬æ¢å™¨
â”‚       â””â”€â”€ claude-to-gemini.ts               # Gemini æ ¼å¼è½¬æ¢å™¨
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ result-handler.ts                     # ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â””â”€â”€ kv-validator.ts                       # KV ç»‘å®šéªŒè¯ä¸­é—´ä»¶
â”œâ”€â”€ constants/                                # å¸¸é‡å®šä¹‰æ¨¡å—
â”‚   â”œâ”€â”€ index.ts                              # å¸¸é‡å…¥å£
â”‚   â”œâ”€â”€ transformer.ts                        # è½¬æ¢å™¨å¸¸é‡
â”‚   â”œâ”€â”€ errors/                               # é”™è¯¯å¸¸é‡
â”‚   â””â”€â”€ proxy/                                # ä»£ç†ç›¸å…³å¸¸é‡
â”œâ”€â”€ types/                                    # ç±»å‹å®šä¹‰æ¨¡å—
â”‚   â”œâ”€â”€ index.ts                              # ç±»å‹å…¥å£
â”‚   â”œâ”€â”€ env.ts                                # ç¯å¢ƒå˜é‡å’Œç»‘å®šç±»å‹
â”‚   â”œâ”€â”€ transformer.ts                        # è½¬æ¢å™¨ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ middleware/                           # ä¸­é—´ä»¶ç±»å‹
â”‚   â””â”€â”€ proxy/                                # ä»£ç†ç›¸å…³ç±»å‹
â””â”€â”€ utils/
    â”œâ”€â”€ errors.ts                             # è‡ªå®šä¹‰é”™è¯¯ç±»å‹
    â”œâ”€â”€ response.ts                           # å“åº”å·¥å…·å‡½æ•°
    â”œâ”€â”€ validators.ts                         # éªŒè¯å·¥å…·å‡½æ•°
    â””â”€â”€ local-kv-storage.ts                  # æœ¬åœ° KV å­˜å‚¨å®ç°
```

#### å‰ç«¯æ–‡ä»¶ç»“æ„
```
packages/frontend/
â”œâ”€â”€ nuxt.config.ts                            # ç”Ÿäº§é…ç½®
â”œâ”€â”€ nuxt.config.dev.ts                       # å¼€å‘é…ç½®
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ index.vue                             # é¦–é¡µï¼ˆé‡å®šå‘åˆ°ç®¡ç†ä¸­å¿ƒï¼‰
â”‚   â””â”€â”€ admin/
â”‚       â”œâ”€â”€ index.vue                         # ç®¡ç†ä¸­å¿ƒç™»å½•é¡µ
â”‚       â”œâ”€â”€ dashboard.vue                     # ä¸»ä»ªè¡¨æ¿
â”‚       â””â”€â”€ add-provider.vue                  # æ·»åŠ ä¾›åº”å•†é¡µé¢
â”œâ”€â”€ components/
â”‚   â””â”€â”€ ProviderForm.vue                      # ä¾›åº”å•†è¡¨å•ç»„ä»¶
â””â”€â”€ assets/css/
    â””â”€â”€ main.css                              # Tailwind CSS æ ·å¼
```

#### å…±äº«ä»£ç 
```
shared/
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ index.ts                              # ç±»å‹å…¥å£
â”‚   â”œâ”€â”€ api.ts                                # é€šç”¨ API ç±»å‹
â”‚   â”œâ”€â”€ auth.ts                               # è®¤è¯ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ key-pool.ts                           # Key Pool ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ admin/                                # ç®¡ç†ä¸­å¿ƒç±»å‹æ¨¡å—
â”‚       â”œâ”€â”€ index.ts                          # ç®¡ç†ç±»å‹å…¥å£
â”‚       â”œâ”€â”€ auth.ts                           # ç®¡ç†è®¤è¯ç±»å‹
â”‚       â”œâ”€â”€ dashboard.ts                      # ä»ªè¡¨æ¿ç±»å‹
â”‚       â”œâ”€â”€ models.ts                         # æ¨¡å‹ç®¡ç†ç±»å‹
â”‚       â”œâ”€â”€ providers.ts                      # ä¾›åº”å•†ç±»å‹
â”‚       â””â”€â”€ claude-accounts.ts                # Claude è´¦å·ç±»å‹
â””â”€â”€ constants/
    â”œâ”€â”€ index.ts                              # å¸¸é‡å…¥å£
    â”œâ”€â”€ endpoints.ts                          # API ç«¯ç‚¹å¸¸é‡
    â”œâ”€â”€ errors.ts                             # é”™è¯¯ç å®šä¹‰
    â”œâ”€â”€ oauth.ts                              # OAuth ç›¸å…³å¸¸é‡
    â””â”€â”€ admin/                                # ç®¡ç†ä¸­å¿ƒå¸¸é‡æ¨¡å—
        â”œâ”€â”€ index.ts                          # ç®¡ç†å¸¸é‡å…¥å£
        â”œâ”€â”€ providers.ts                      # ä¾›åº”å•†é¢„è®¾é…ç½®
        â””â”€â”€ storage.ts                        # å­˜å‚¨é”®åå¸¸é‡
```

### å¼€å‘æœ€ä½³å®è·µ

#### ä»£ç ç»„ç»‡åŸåˆ™
- **åˆ†å±‚æ¶æ„**: ä¸¥æ ¼çš„è·¯ç”±â†’æœåŠ¡â†’å­˜å‚¨åˆ†å±‚ï¼ŒèŒè´£æ˜ç¡®
- **ç±»å‹å®‰å…¨**: å…¨é“¾è·¯ TypeScript ç±»å‹çº¦æŸï¼Œå…±äº«ç±»å‹å®šä¹‰
- **é”™è¯¯ä¼˜å…ˆ**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **æ— çŠ¶æ€è®¾è®¡**: åˆ©ç”¨ KV å­˜å‚¨å®ç°çŠ¶æ€æŒä¹…åŒ–ï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

#### API å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ
- **ç»Ÿä¸€ Key Pool ç®¡ç†**: æ‰€æœ‰ API å¯†é’¥å¿…é¡»é€šè¿‡ Key Pool ç³»ç»Ÿç®¡ç†ï¼Œä¸åœ¨ä¾›åº”å•†é…ç½®ä¸­å­˜å‚¨
- **å®‰å…¨å­˜å‚¨**: API å¯†é’¥åŠ å¯†å­˜å‚¨åœ¨ä¸“ç”¨çš„ KV å­˜å‚¨ç©ºé—´ä¸­
- **æ™ºèƒ½è½®æ¢**: æ”¯æŒå¤šç§è½®æ¢ç­–ç•¥ï¼Œé¿å…å•ä¸ªå¯†é’¥è¿‡è½½
- **æ•…éšœéš”ç¦»**: å•ä¸ªå¯†é’¥æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡å¯ç”¨æ€§
- **å®æ—¶ç›‘æ§**: æŒç»­ç›‘æ§å¯†é’¥ä½¿ç”¨æƒ…å†µå’Œå¥åº·çŠ¶æ€
- **æ‰¹é‡ç®¡ç†**: æ”¯æŒä¼ä¸šçº§çš„æ‰¹é‡å¯†é’¥å¯¼å…¥å’Œç®¡ç†æ“ä½œ
- **è‡ªåŠ¨æ¢å¤**: æ•…éšœå¯†é’¥å®šæ—¶è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤æœºåˆ¶

#### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- **æµå¼å“åº”**: ç›´æ¥è½¬å‘æµå¼å“åº”ï¼Œæ”¯æŒ Claude å’Œ OpenAI æ ¼å¼
- **æ™ºèƒ½è·¯ç”±**: æ ¹æ®é€‰ä¸­æ¨¡å‹åŠ¨æ€è·¯ç”±ï¼Œé¿å…ä¸å¿…è¦çš„è½¬æ¢
- **å¹¶å‘æ§åˆ¶**: å¼‚æ­¥å¤„ç†å’Œé€‚å½“çš„è¶…æ—¶æ§åˆ¶
- **ç¼“å­˜ä¼˜åŒ–**: å‰ç«¯é™æ€èµ„æºç¼“å­˜ï¼ŒAPI å“åº”ç¼“å­˜ç­–ç•¥

## ç®¡ç†ä¸­å¿ƒåŠŸèƒ½

### åŠŸèƒ½æ¦‚è¿°

ç®¡ç†ä¸­å¿ƒæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ Web ç•Œé¢æ¥ç®¡ç† Claude è´¦å·ã€ç¬¬ä¸‰æ–¹æ¨¡å‹ä¾›åº”å•†é…ç½®å’Œæ¨¡å‹é€‰æ‹©ã€‚

#### æ ¸å¿ƒåŠŸèƒ½
- **ğŸ” ç®¡ç†å‘˜è®¤è¯**: åŸºäºç¯å¢ƒå˜é‡çš„å®‰å…¨è®¤è¯æœºåˆ¶
- **ğŸ‘¤ Claude è´¦å·ç®¡ç†**: æ·»åŠ ã€åˆ é™¤ Claude è´¦å·ï¼ŒOAuth è®¤è¯ï¼ŒToken è‡ªåŠ¨åˆ·æ–°
- **ğŸ“Š ç³»ç»Ÿä»ªè¡¨æ¿**: æ˜¾ç¤ºè´¦å·çŠ¶æ€ã€ä¾›åº”å•†ç»Ÿè®¡ã€ç³»ç»Ÿå¥åº·çŠ¶æ€ç­‰ä¿¡æ¯
- **ğŸ”§ æ¨¡å‹ä¾›åº”å•†ç®¡ç†**: æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ç¬¬ä¸‰æ–¹ AI æ¨¡å‹ä¾›åº”å•†
- **ğŸ¯ æ¨¡å‹é€‰æ‹©**: åœ¨å®˜æ–¹ Claude å’Œç¬¬ä¸‰æ–¹æ¨¡å‹é—´åˆ‡æ¢é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹
- **ğŸ”‘ Key Pool ç®¡ç†**: ä¼ä¸šçº§ API å¯†é’¥æ± ç®¡ç†ï¼Œæ”¯æŒæ‰¹é‡å¯¼å…¥ã€æ™ºèƒ½è½®æ¢å’Œæ•…éšœæ¢å¤
- **ğŸ”„ æ™ºèƒ½è·¯ç”±**: è‡ªåŠ¨å°†è¯·æ±‚è·¯ç”±åˆ°é€‰ä¸­çš„æ¨¡å‹ä¾›åº”å•†

#### é¢„è®¾ä¾›åº”å•†æ”¯æŒ
- **é­”æ­ Qwen**: é˜¿é‡Œäº‘é­”æ­ç¤¾åŒºçš„ Qwen ç³»åˆ—æ¨¡å‹ï¼ˆclaude-to-openai è½¬æ¢å™¨ï¼‰
- **æ™ºè°± AI**: GLM-4 ç­‰å…ˆè¿›è¯­è¨€æ¨¡å‹ï¼ˆclaude-to-openai è½¬æ¢å™¨ï¼‰
- **Google Gemini**: Google çš„ Gemini ç³»åˆ—æ¨¡å‹ï¼ˆclaude-to-gemini è½¬æ¢å™¨ï¼‰
- **OpenAI Compatible**: å…¼å®¹ OpenAI API çš„å…¶ä»–æœåŠ¡

### è®¿é—®æ–¹å¼

#### å¼€å‘ç¯å¢ƒ
- **å‰ç«¯å¼€å‘**: `http://localhost:3000/admin`
- **åç«¯ API**: `http://localhost:8787`
- **å¼€å‘é…ç½®**: å‰ç«¯è‡ªåŠ¨è¿æ¥æœ¬åœ°åç«¯ API

#### ç”Ÿäº§ç¯å¢ƒ
- **ç®¡ç†ä¸­å¿ƒ**: `https://claude-relay-frontend.pages.dev/admin`
- **åç«¯ API**: `https://claude-relay-backend.117yelixin.workers.dev`
- **é»˜è®¤å‡­æ®**: é€šè¿‡ Cloudflare Dashboard ç¯å¢ƒå˜é‡è®¾ç½®

### Claude è´¦å·ç®¡ç†

#### Claude è´¦å·åŠŸèƒ½
1. **æ·»åŠ è´¦å·**: åˆ›å»ºæ–°çš„ Claude è´¦å·é…ç½®
2. **OAuth è®¤è¯**: é€šè¿‡ Claude å®˜æ–¹ OAuth æµç¨‹è·å–è®¿é—®ä»¤ç‰Œ
3. **Token ç®¡ç†**: è‡ªåŠ¨åˆ·æ–°è¿‡æœŸçš„è®¿é—®ä»¤ç‰Œ
4. **çŠ¶æ€ç›‘æ§**: å®æ—¶æ˜¾ç¤ºè´¦å·çŠ¶æ€ï¼ˆæ´»è·ƒ/ä¸æ´»è·ƒ/è¿‡æœŸï¼‰

#### OAuth è®¤è¯æµç¨‹
1. åœ¨ç®¡ç†ä¸­å¿ƒæ·»åŠ æ–°çš„ Claude è´¦å·
2. ç³»ç»Ÿç”Ÿæˆ OAuth è®¤è¯é“¾æ¥ï¼ˆPKCE å®‰å…¨æµç¨‹ï¼‰
3. ç”¨æˆ·è®¿é—®é“¾æ¥å®Œæˆ Claude å®˜æ–¹æˆæƒ
4. ç³»ç»Ÿæ¥æ”¶æˆæƒç å¹¶äº¤æ¢è®¿é—®ä»¤ç‰Œ
5. Token å­˜å‚¨åˆ° KV å¹¶è®¾ç½®è‡ªåŠ¨åˆ·æ–°

### æ¨¡å‹ä¾›åº”å•†é…ç½®

#### æ·»åŠ ä¾›åº”å•†æµç¨‹
1. **é€‰æ‹©ä¾›åº”å•†ç±»å‹**: OpenAI å…¼å®¹æˆ– Google Gemini
2. **é€‰æ‹©é¢„è®¾æ¨¡æ¿**: é­”æ­ã€æ™ºè°± AIã€Google Gemini æˆ–è‡ªå®šä¹‰
3. **å¡«å†™é…ç½®ä¿¡æ¯**: 
   - ä¾›åº”å•†åç§°å’Œæè¿°
   - API ç«¯ç‚¹ URL
   - æ¨¡å‹åç§°
   - è½¬æ¢å™¨ç±»å‹ï¼ˆè‡ªåŠ¨é€‰æ‹©æˆ–æ‰‹åŠ¨æŒ‡å®šï¼‰
   - æ³¨æ„ï¼šAPI å¯†é’¥ç»Ÿä¸€é€šè¿‡ Key Pool ç®¡ç†ï¼Œä¸åœ¨æ­¤å¤„é…ç½®
4. **ä¿å­˜é…ç½®**: ä¾›åº”å•†é…ç½®å®‰å…¨å­˜å‚¨åˆ° KV
5. **é€‰æ‹©ä½¿ç”¨**: åœ¨æ¨¡å‹é€‰æ‹©é¡µé¢åˆ‡æ¢åˆ°æ–°æ·»åŠ çš„ä¾›åº”å•†

#### æ™ºèƒ½è·¯ç”±å·¥ä½œæµç¨‹
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ° `/v1/messages`
2. ç³»ç»Ÿæ£€æŸ¥å½“å‰é€‰ä¸­çš„æ¨¡å‹é…ç½®
3. **å®˜æ–¹ Claude**: ç›´æ¥è½¬å‘åˆ° Claude API
4. **ç¬¬ä¸‰æ–¹ä¾›åº”å•†**: 
   - ä½¿ç”¨å¯¹åº”è½¬æ¢å™¨è½¬æ¢è¯·æ±‚æ ¼å¼
   - è½¬å‘åˆ°ä¾›åº”å•† API
   - è½¬æ¢å“åº”æ ¼å¼è¿”å›
5. è¿”å›æ ‡å‡† Claude API æ ¼å¼å“åº”

### Key Pool ç®¡ç†åŠŸèƒ½

Key Pool æ˜¯ Claude Relay çš„ä¼ä¸šçº§æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›äº†å®Œæ•´çš„ API å¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç†è§£å†³æ–¹æ¡ˆã€‚

#### Key Pool åŠŸèƒ½ç‰¹æ€§
1. **ä¼ä¸šçº§å¯†é’¥ç®¡ç†**: æ”¯æŒå¤§è§„æ¨¡ API å¯†é’¥çš„ç»Ÿä¸€ç®¡ç†å’Œç›‘æ§
2. **æ‰¹é‡æ“ä½œæ”¯æŒ**: æ”¯æŒæ‰¹é‡å¯¼å…¥ã€å¯ç”¨ã€ç¦ç”¨å’Œåˆ é™¤ API å¯†é’¥
3. **æ™ºèƒ½è½®æ¢ç­–ç•¥**: æ”¯æŒ round-robinã€randomã€least-used ç­‰å¤šç§è½®æ¢ç­–ç•¥
4. **æ•…éšœè‡ªåŠ¨æ¢å¤**: è‡ªåŠ¨æ£€æµ‹é€Ÿç‡é™åˆ¶å’Œ API é”™è¯¯ï¼Œå®šæ—¶æ¢å¤ä¸å¯ç”¨çš„å¯†é’¥
5. **å®æ—¶ç»Ÿè®¡ç›‘æ§**: è¿½è¸ªæ¯ä¸ªå¯†é’¥çš„ä½¿ç”¨æ¬¡æ•°ã€æˆåŠŸç‡ã€å¤±è´¥åŸå› ç­‰è¯¦ç»†ç»Ÿè®¡
6. **è´Ÿè½½å‡è¡¡**: æ ¹æ®å¯†é’¥æ€§èƒ½å’Œä½¿ç”¨æƒ…å†µæ™ºèƒ½åˆ†é…è¯·æ±‚
7. **å®‰å…¨å­˜å‚¨**: å¯†é’¥åŠ å¯†å­˜å‚¨ï¼Œä¸ä¾›åº”å•†é…ç½®åˆ†ç¦»ç®¡ç†
8. **ç»´æŠ¤ä»»åŠ¡**: æ”¯æŒæ‰‹åŠ¨å’Œè‡ªåŠ¨çš„å¯†é’¥æ± ç»´æŠ¤æ“ä½œ

#### Key Pool ç®¡ç†ç•Œé¢
åœ¨ç®¡ç†ä¸­å¿ƒçš„ä¾›åº”å•†æ ‡ç­¾é¡µä¸­ï¼Œæ¯ä¸ªä¾›åº”å•†éƒ½æœ‰ä¸“é—¨çš„ Key Pool ç®¡ç†å…¥å£ï¼š
- **å¯†é’¥åˆ—è¡¨**: æ˜¾ç¤ºæ‰€æœ‰å¯†é’¥çš„çŠ¶æ€ã€ä½¿ç”¨ç»Ÿè®¡å’Œå¥åº·æƒ…å†µ
- **æ‰¹é‡å¯¼å…¥**: æ”¯æŒä¸€æ¬¡æ€§å¯¼å…¥å¤šä¸ª API å¯†é’¥
- **çŠ¶æ€ç®¡ç†**: å•ç‹¬æˆ–æ‰¹é‡å¯ç”¨/ç¦ç”¨å¯†é’¥
- **ç»Ÿè®¡å›¾è¡¨**: å¯è§†åŒ–æ˜¾ç¤ºå¯†é’¥ä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½æŒ‡æ ‡
- **ç»´æŠ¤å·¥å…·**: ä¸€é”®æ‰§è¡Œå¯†é’¥æ± æ¸…ç†å’Œæ¢å¤ä»»åŠ¡

#### Key Pool ä½¿ç”¨åœºæ™¯
- **é«˜å¹¶å‘åœºæ™¯**: å¤šä¸ª API å¯†é’¥è½®æ¢ä½¿ç”¨ï¼Œé¿å…å•ä¸ªå¯†é’¥è¾¾åˆ°é€Ÿç‡é™åˆ¶
- **ä¼ä¸šçº§éƒ¨ç½²**: ç»Ÿä¸€ç®¡ç†å¤šä¸ªä¾›åº”å•†çš„å¤§é‡ API å¯†é’¥
- **æ•…éšœå®¹é”™**: æŸä¸ªå¯†é’¥å¤±æ•ˆæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å¯ç”¨å¯†é’¥
- **æˆæœ¬ä¼˜åŒ–**: æ ¹æ®å¯†é’¥ä½¿ç”¨æƒ…å†µä¼˜åŒ– API è°ƒç”¨æˆæœ¬
- **åˆè§„ç®¡ç†**: é›†ä¸­ç®¡ç†å’Œå®¡è®¡ API å¯†é’¥çš„ä½¿ç”¨æƒ…å†µ

#### Key Pool å·¥ä½œåŸç†
1. **å¯†é’¥æ³¨å†Œ**: å°†å¤šä¸ª API å¯†é’¥æ·»åŠ åˆ°å¯¹åº”ä¾›åº”å•†çš„å¯†é’¥æ± 
2. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥å¯†é’¥çŠ¶æ€ï¼Œæ ‡è®°ä¸å¯ç”¨çš„å¯†é’¥
3. **æ™ºèƒ½é€‰æ‹©**: æ ¹æ®é…ç½®çš„è½®æ¢ç­–ç•¥é€‰æ‹©æœ€ä¼˜å¯†é’¥
4. **é”™è¯¯å¤„ç†**: æ£€æµ‹åˆ°é”™è¯¯æ—¶æ ‡è®°å¯†é’¥çŠ¶æ€ï¼Œå¿…è¦æ—¶åˆ‡æ¢åˆ°å¤‡ç”¨å¯†é’¥
5. **è‡ªåŠ¨æ¢å¤**: å®šæ—¶é‡è¯•è¢«æ ‡è®°ä¸ºé”™è¯¯çš„å¯†é’¥ï¼Œæ¢å¤å…¶å¯ç”¨çŠ¶æ€
6. **ç»Ÿè®¡æ”¶é›†**: å®æ—¶æ”¶é›†ä½¿ç”¨æ•°æ®ï¼Œä¸ºæ™ºèƒ½è°ƒåº¦æä¾›ä¾æ®

#### Key Pool API ç®¡ç†ç«¯ç‚¹
- `GET /api/admin/key-pool/:providerId` - è·å–æŒ‡å®šä¾›åº”å•†çš„å¯†é’¥æ± çŠ¶æ€å’Œå¯†é’¥åˆ—è¡¨
- `POST /api/admin/key-pool/:providerId/keys` - å‘å¯†é’¥æ± æ·»åŠ æ–°çš„ API å¯†é’¥
- `PUT /api/admin/key-pool/:providerId/keys/:keyId` - æ›´æ–°æŒ‡å®šå¯†é’¥çš„çŠ¶æ€ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- `DELETE /api/admin/key-pool/:providerId/keys/:keyId` - åˆ é™¤æŒ‡å®šçš„ API å¯†é’¥
- `POST /api/admin/key-pool/:providerId/keys/batch` - æ‰¹é‡æ·»åŠ å¤šä¸ª API å¯†é’¥
- `POST /api/admin/key-pool/:providerId/keys/batch-operation` - æ‰¹é‡æ“ä½œå¯†é’¥ï¼ˆå¯ç”¨/ç¦ç”¨/åˆ é™¤ï¼‰
- `GET /api/admin/key-pool/:providerId/stats` - è·å–å¯†é’¥æ± çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯å’Œæ€§èƒ½æŒ‡æ ‡
- `POST /api/admin/key-pool/:providerId/maintenance` - æ‰§è¡Œå¯†é’¥æ± ç»´æŠ¤ä»»åŠ¡ï¼ˆæ¸…ç†ã€æ¢å¤ç­‰ï¼‰

### é¡µé¢ç»“æ„

```
/                         # é¦–é¡µï¼ˆè‡ªåŠ¨é‡å®šå‘åˆ°ç®¡ç†ä¸­å¿ƒï¼‰
/admin                    # ç®¡ç†ä¸­å¿ƒç™»å½•é¡µé¢
â”œâ”€â”€ /admin/dashboard      # ä¸»ä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ Claude è´¦å·æ ‡ç­¾é¡µ  # Claude è´¦å·ç®¡ç†ï¼ˆé»˜è®¤é¡µé¢ï¼‰
â”‚   â”œâ”€â”€ æ¨¡å‹ä¾›åº”å•†æ ‡ç­¾é¡µ    # ç¬¬ä¸‰æ–¹ AI æ¨¡å‹ä¾›åº”å•†ç®¡ç†
â”‚   â”‚   â””â”€â”€ Key Pool ç®¡ç† # æ¯ä¸ªä¾›åº”å•†çš„å¯†é’¥æ± ç®¡ç†å…¥å£
â”‚   â””â”€â”€ æ¨¡å‹é€‰æ‹©æ ‡ç­¾é¡µ      # é€‰æ‹©é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹
â””â”€â”€ /admin/add-provider   # æ·»åŠ ä¾›åº”å•†é¡µé¢ï¼ˆæ™ºèƒ½å¯¼èˆªè¿”å›åˆ°ä¾›åº”å•†æ ‡ç­¾é¡µï¼‰
```

### éƒ¨ç½²é…ç½®

#### ç¯å¢ƒå˜é‡è®¾ç½®ï¼ˆCloudflare Dashboardï¼‰
```bash
# ç®¡ç†å‘˜å‡­æ®ï¼ˆå¿…é¡»åœ¨ Dashboard ä¸­è®¾ç½®ï¼Œä¸è¦å†™åœ¨ wrangler.tomlï¼‰
ADMIN_USERNAME=your_admin_username
ADMIN_PASSWORD=your_secure_password

# å¯é€‰ï¼šClaude OAuth åº”ç”¨é…ç½®
CLAUDE_CLIENT_ID=your_client_id
CLAUDE_CLIENT_SECRET=your_client_secret
```

#### KV å‘½åç©ºé—´
- **ç»‘å®šå**: `CLAUDE_RELAY_ADMIN_KV`
- **ç”¨é€”**: å­˜å‚¨ Claude è´¦å·ã€ä¾›åº”å•†é…ç½®ã€ç³»ç»Ÿè®¾ç½®ç­‰æ‰€æœ‰æ•°æ®
- **é…ç½®**: åœ¨ `wrangler.toml` ä¸­å·²æ­£ç¡®é…ç½®

### ç³»ç»Ÿç‰¹æ€§

#### å®‰å…¨ç‰¹æ€§
- ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
- OAuth PKCE æµç¨‹ç¡®ä¿è®¤è¯å®‰å…¨
- API å¯†é’¥åŠ å¯†å­˜å‚¨åœ¨ KV ä¸­
- CORS é…ç½®å…è®¸è·¨åŸŸè®¿é—®

#### è‡ªåŠ¨åŒ–ç‰¹æ€§
- å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åˆ·æ–° Claude è´¦å· Token
- æ™ºèƒ½é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- å®æ—¶çŠ¶æ€ç›‘æ§å’Œå¥åº·æ£€æŸ¥
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯è®¿é—®

#### æ‰©å±•æ€§ç‰¹æ€§
- æ’ä»¶åŒ–è½¬æ¢å™¨ç³»ç»Ÿï¼Œæ”¯æŒæ·»åŠ æ–°çš„ API æ ¼å¼
- æ¨¡å—åŒ–æ¶æ„ï¼Œæ˜“äºæ·»åŠ æ–°çš„ä¾›åº”å•†ç±»å‹
- ç±»å‹å®‰å…¨çš„é…ç½®ç®¡ç†ï¼Œå‡å°‘é…ç½®é”™è¯¯
- ç»Ÿä¸€çš„ API æ¥å£ï¼Œæ”¯æŒå¤šç§å®¢æˆ·ç«¯

ä»£ç åº“è®¾è®¡é‡ç‚¹å…³æ³¨å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§å’Œç”¨æˆ·ä½“éªŒï¼Œä¸º Claude Code å’Œå…¶ä»–å®¢æˆ·ç«¯æä¾›ç¨³å®šå¯é çš„å¤šæ¨¡å‹ä»£ç†æœåŠ¡ã€‚